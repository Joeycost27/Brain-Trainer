<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FocusForge ‚Äî Daily Mission</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Exo+2:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#07090f;--surface:#111625;--surface2:#181e30;--surface3:#1f263d;
  --border:rgba(255,255,255,0.07);--border2:rgba(255,255,255,0.14);
  --text:#dde3f5;--muted:#5a6585;--muted2:#8591b0;
  --gold:#ffd447;--teal:#00e5cc;--rose:#ff5e7d;--lime:#5cff8f;--violet:#9b6dff;
  --cat-ef:#ff5e5e;--cat-wm:#00d4c8;--cat-fs:#ffcc00;--cat-im:#4cd97b;
  --cat-er:#ff7eb3;--cat-rw:#4da6ff;--cat-tp:#a278ff;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Exo 2',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
button{font-family:'Exo 2',sans-serif;cursor:pointer}

body::before{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:radial-gradient(ellipse 70% 50% at 30% 20%,rgba(155,109,255,.06) 0%,transparent 60%),
  radial-gradient(ellipse 60% 40% at 70% 70%,rgba(0,229,204,.04) 0%,transparent 60%)}

.app{position:relative;z-index:1;max-width:680px;margin:0 auto;padding:0 20px 80px;min-height:100vh;display:flex;flex-direction:column}

/* NAV */
nav{display:flex;align-items:center;justify-content:space-between;padding:22px 0 28px}
.nav-back{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:.82rem;font-weight:700;text-decoration:none;transition:color .15s;letter-spacing:.5px}
.nav-back:hover{color:var(--text)}
.nav-title{font-family:'Fredoka One',cursive;font-size:1.1rem;color:var(--muted2)}
.btn-ta-sm{display:flex;align-items:center;gap:6px;background:var(--surface2);border:1px solid rgba(155,109,255,.3);border-radius:50px;padding:7px 14px;color:#c4b5fd;font-size:.76rem;font-weight:700;transition:all .15s}
.btn-ta-sm:hover{border-color:rgba(155,109,255,.6);background:rgba(155,109,255,.12)}
.ta-dot{width:6px;height:6px;border-radius:50%;background:var(--lime);box-shadow:0 0 6px var(--lime);animation:pd 2s infinite}
@keyframes pd{0%,100%{opacity:1}50%{opacity:.4}}

/* MISSION HEADER */
.mission-header{text-align:center;margin-bottom:32px;animation:fadeUp .4s ease both}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.mission-label{font-size:.68rem;text-transform:uppercase;letter-spacing:3px;color:var(--violet);font-weight:700;margin-bottom:8px}
.mission-title{font-family:'Fredoka One',cursive;font-size:2rem;margin-bottom:6px}
.mission-date{font-size:.78rem;color:var(--muted);margin-bottom:20px}

/* PROGRESS PIPS */
.pips{display:flex;justify-content:center;gap:10px;margin-bottom:32px}
.pip{width:36px;height:6px;border-radius:50px;background:var(--surface2);border:1px solid var(--border);transition:all .3s}
.pip.active{background:var(--violet);box-shadow:0 0 10px rgba(155,109,255,.5);border-color:transparent}
.pip.done{background:var(--lime);box-shadow:0 0 8px rgba(92,255,143,.4);border-color:transparent}
.pip.boss{background:var(--rose);box-shadow:0 0 10px rgba(255,94,125,.5);border-color:transparent}

/* ‚îÄ‚îÄ BRIEFING SCREEN ‚îÄ‚îÄ */
#screen-brief{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center}
.brief-icons{display:flex;gap:14px;margin-bottom:28px}
.brief-cat-icon{width:56px;height:56px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:1.6rem;border:1px solid var(--border2);background:var(--surface);animation:fadeUp .4s ease both}
.brief-cat-icon:nth-child(2){animation-delay:.06s}.brief-cat-icon:nth-child(3){animation-delay:.12s}.brief-cat-icon:nth-child(4){animation-delay:.18s}
.brief-text{text-align:center;margin-bottom:36px;animation:fadeUp .4s .2s ease both}
.brief-text h2{font-family:'Fredoka One',cursive;font-size:1.5rem;margin-bottom:8px}
.brief-text p{font-size:.84rem;color:var(--muted2);line-height:1.6;max-width:420px}
.boss-warn{background:rgba(255,94,125,.08);border:1px solid rgba(255,94,125,.25);border-radius:14px;padding:12px 18px;margin-bottom:24px;font-size:.8rem;color:#ffb3c1;text-align:center;display:none;animation:fadeUp .4s .25s ease both}
.btn-start{padding:16px 48px;background:linear-gradient(135deg,var(--violet),var(--teal));border:none;border-radius:50px;color:#fff;font-weight:900;font-size:1rem;letter-spacing:.5px;box-shadow:0 6px 28px rgba(155,109,255,.35);transition:all .2s;animation:fadeUp .4s .3s ease both}
.btn-start:hover{transform:translateY(-3px);box-shadow:0 12px 36px rgba(155,109,255,.45)}

/* ‚îÄ‚îÄ CARD SCREEN ‚îÄ‚îÄ */
#screen-card{flex:1;display:none;flex-direction:column}

/* Flip card */
.flip-area{perspective:1400px;margin-bottom:20px;flex:1;min-height:380px;cursor:pointer}
.flipper{width:100%;height:100%;min-height:380px;transition:transform .55s cubic-bezier(.4,0,.2,1);transform-style:preserve-3d;position:relative}
.flipper.flipped{transform:rotateY(180deg)}
.card-face{position:absolute;inset:0;backface-visibility:hidden;border-radius:24px;padding:28px;display:flex;flex-direction:column}
.card-front{background:var(--surface);border:1px solid var(--border2)}
.card-back{background:var(--surface2);border:1px solid var(--border2);transform:rotateY(180deg)}

/* Front face */
.cf-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px}
.cf-cat{font-size:.68rem;text-transform:uppercase;letter-spacing:1.5px;font-weight:800;padding:5px 12px;border-radius:50px;border:1px solid color-mix(in srgb,var(--cc,#9b6dff) 30%,transparent);background:color-mix(in srgb,var(--cc,#9b6dff) 12%,transparent);color:var(--cc,#9b6dff)}
.cf-badges{display:flex;gap:6px;align-items:center}
.cf-time{font-size:.72rem;font-weight:700;color:var(--muted);background:var(--surface2);border:1px solid var(--border);border-radius:50px;padding:4px 10px}
.cf-type{font-size:1rem}
.boss-tag{font-size:.66rem;font-weight:800;color:var(--rose);background:rgba(255,94,125,.12);border:1px solid rgba(255,94,125,.3);border-radius:50px;padding:3px 10px;text-transform:uppercase;letter-spacing:1px}
.cf-id{font-size:.65rem;color:var(--muted);font-weight:600;letter-spacing:.5px}

.cf-icon-area{flex:1;display:flex;align-items:center;justify-content:center;padding:10px 0}
.cf-big-icon{font-size:4.5rem;filter:drop-shadow(0 4px 16px color-mix(in srgb,var(--cc,#9b6dff) 40%,transparent))}

.cf-bottom{margin-top:auto}
.cf-title{font-family:'Fredoka One',cursive;font-size:1.5rem;margin-bottom:8px;line-height:1.2}
.cf-prompt{font-size:.84rem;color:var(--muted2);line-height:1.55;margin-bottom:16px}
.cf-flip-hint{display:flex;align-items:center;justify-content:center;gap:6px;font-size:.72rem;color:var(--muted);font-weight:600;letter-spacing:.5px;text-transform:uppercase;animation:bounce 2s infinite}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}

/* Back face */
.cb-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.cb-section-lbl{font-size:.63rem;text-transform:uppercase;letter-spacing:2px;color:var(--cc,#9b6dff);font-weight:800}
.cb-flip-back{font-size:.7rem;color:var(--muted);background:var(--surface3);border:1px solid var(--border);border-radius:50px;padding:4px 12px;font-weight:600}

.cb-instructions{font-size:.84rem;color:var(--text);line-height:1.75;margin-bottom:16px}

.cb-success{display:flex;gap:10px;align-items:flex-start;background:rgba(92,255,143,.06);border:1px solid rgba(92,255,143,.2);border-radius:13px;padding:12px 14px;margin-bottom:14px}
.cb-success .tick{font-size:.95rem;flex-shrink:0;margin-top:2px}
.cb-success p{font-size:.8rem;color:#8de8a4;line-height:1.55}

.cb-mats{display:flex;gap:8px;align-items:center;padding:9px 12px;border-radius:10px;background:var(--surface3);font-size:.76rem;color:var(--muted);margin-bottom:14px}

.cb-diff{display:flex;align-items:center;gap:6px;margin-bottom:6px}
.dd{width:8px;height:8px;border-radius:50%;background:var(--surface3)}
.dd.lit{background:var(--cc,#9b6dff);box-shadow:0 0 5px var(--cc,#9b6dff)}
.cb-aud{font-size:.68rem;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:1px}

/* Card glow line */
.card-face::before{content:'';position:absolute;top:0;left:16px;right:16px;height:2px;background:linear-gradient(90deg,transparent,var(--cc,#9b6dff),transparent);border-radius:0 0 2px 2px;opacity:.6}

/* CARD ACTIONS */
.card-actions{display:flex;gap:12px;margin-bottom:12px;animation:fadeUp .3s ease both}
.btn-did-it{flex:1;padding:15px;background:linear-gradient(135deg,var(--lime),var(--teal));border:none;border-radius:16px;color:#062010;font-weight:900;font-size:.95rem;transition:all .2s;box-shadow:0 4px 20px rgba(92,255,143,.25)}
.btn-did-it:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(92,255,143,.35)}
.btn-later{padding:15px 20px;background:var(--surface2);border:1px solid var(--border2);border-radius:16px;color:var(--muted2);font-weight:700;font-size:.88rem;transition:all .15s}
.btn-later:hover{color:var(--text);border-color:rgba(255,255,255,.2)}

/* Sage prompt */
.sage-prompt{display:flex;gap:10px;align-items:flex-start;padding:13px 15px;background:rgba(155,109,255,.07);border:1px solid rgba(155,109,255,.2);border-radius:14px;margin-bottom:20px}
.sage-av{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--violet),var(--teal));display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0}
.sage-text{font-size:.78rem;color:var(--muted2);line-height:1.55}
.sage-text strong{color:var(--text)}

/* ‚îÄ‚îÄ XP POP ‚îÄ‚îÄ */
#screen-card .xp-pop{display:none;text-align:center;padding:6px 0;font-family:'Fredoka One',cursive;font-size:1.4rem;color:var(--gold);text-shadow:0 0 16px rgba(255,212,71,.5);animation:xpFloat .6s ease both}
@keyframes xpFloat{from{opacity:0;transform:scale(.5) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}

/* ‚îÄ‚îÄ COMPLETE SCREEN ‚îÄ‚îÄ */
#screen-complete{flex:1;display:none;flex-direction:column;align-items:center;justify-content:center;text-align:center;animation:fadeUp .4s ease both}
.complete-burst{font-size:4rem;margin-bottom:16px;animation:spin1 .6s ease both}
@keyframes spin1{from{transform:rotate(-20deg) scale(.6)}to{transform:rotate(0) scale(1)}}
.complete-title{font-family:'Fredoka One',cursive;font-size:2rem;margin-bottom:8px}
.complete-sub{font-size:.86rem;color:var(--muted2);margin-bottom:28px;line-height:1.6}

.score-row{display:flex;gap:16px;margin-bottom:28px;flex-wrap:wrap;justify-content:center}
.score-chip{padding:12px 22px;border-radius:16px;text-align:center}
.score-chip.xp-chip{background:rgba(255,212,71,.1);border:1px solid rgba(255,212,71,.3)}
.score-chip.done-chip{background:rgba(92,255,143,.08);border:1px solid rgba(92,255,143,.25)}
.score-chip.streak-chip{background:rgba(255,94,125,.08);border:1px solid rgba(255,94,125,.25)}
.sc-n{font-family:'Fredoka One',cursive;font-size:1.8rem;display:block}
.sc-l{font-size:.68rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-top:3px;font-weight:600}
.score-chip.xp-chip .sc-n{color:var(--gold)}
.score-chip.done-chip .sc-n{color:var(--lime)}
.score-chip.streak-chip .sc-n{color:var(--rose)}

.badge-unlock{background:rgba(155,109,255,.1);border:1px solid rgba(155,109,255,.3);border-radius:16px;padding:14px 20px;margin-bottom:24px;display:none}
.badge-unlock p{font-size:.82rem;color:#c4b5fd}

.complete-actions{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
.btn-again{padding:14px 32px;background:linear-gradient(135deg,var(--violet),var(--teal));border:none;border-radius:50px;color:#fff;font-weight:900;font-size:.9rem;transition:all .2s}
.btn-again:hover{transform:translateY(-2px);filter:brightness(1.08)}
.btn-home{padding:14px 28px;background:var(--surface2);border:1px solid var(--border2);border-radius:50px;color:var(--muted2);font-weight:700;font-size:.88rem;transition:all .15s}
.btn-home:hover{color:var(--text)}

/* LOADING/ERROR */
#screen-load{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;text-align:center}
.loader{width:44px;height:44px;border-radius:50%;border:3px solid var(--surface2);border-top-color:var(--violet);animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#screen-load p{font-size:.84rem;color:var(--muted)}
#screen-load h3{font-family:'Fredoka One',cursive;font-size:1.4rem}

/* TOAST */
#toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(30px);background:var(--surface2);border:1px solid var(--border2);border-radius:50px;padding:10px 20px;font-size:.82rem;font-weight:700;color:var(--text);z-index:300;pointer-events:none;white-space:nowrap;transition:transform .28s,opacity .28s;opacity:0;box-shadow:0 8px 32px rgba(0,0,0,.5)}
#toast.show{transform:translateX(-50%) translateY(0);opacity:1}

::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:2px}

@media(max-width:500px){
  .mission-title{font-size:1.6rem}
  .cf-big-icon{font-size:3.5rem}
  .cf-title{font-size:1.3rem}
  .complete-title{font-size:1.6rem}
}
</style>
</head>
<body>
<div class="app">

  <nav>
    <a class="nav-back" href="index.html">‚Üê Hub</a>
    <span class="nav-title">Daily Mission</span>
    <button class="btn-ta-sm" onclick="openTA()"><div class="ta-dot"></div>Ask Sage</button>
  </nav>

  <!-- LOADING -->
  <div id="screen-load">
    <div class="loader"></div>
    <p>Loading today's mission‚Ä¶</p>
  </div>

  <!-- BRIEFING -->
  <div id="screen-brief" style="display:none">
    <div class="mission-header">
      <div class="mission-label">Today's Challenge</div>
      <div class="mission-title" id="brief-title">Daily Mission</div>
      <div class="mission-date" id="brief-date"></div>
    </div>
    <div class="pips" id="pips-brief"></div>
    <div class="brief-icons" id="brief-icons"></div>
    <div class="brief-text">
      <h2>Your mission for today</h2>
      <p>Each card is a real-world activity. Flip to see the full instructions. Mark it done when you've completed it ‚Äî even a partial attempt counts.</p>
    </div>
    <div class="boss-warn" id="boss-warn">üëπ <strong>Boss Round active!</strong> You're on a streak ‚Äî a harder challenge has been added. Double XP if you complete it.</div>
    <button class="btn-start" onclick="startMission()">Start Mission ‚Üí</button>
  </div>

  <!-- CARD -->
  <div id="screen-card" style="display:none;flex-direction:column">
    <div class="mission-header" style="margin-bottom:16px">
      <div class="mission-label" id="card-counter">Card 1 of 3</div>
    </div>
    <div class="pips" id="pips-card"></div>

    <div class="flip-area" onclick="flipCard()" id="flip-area">
      <div class="flipper" id="flipper">
        <!-- Front -->
        <div class="card-face card-front" id="card-front"></div>
        <!-- Back -->
        <div class="card-face card-back" id="card-back"></div>
      </div>
    </div>

    <div class="sage-prompt" id="sage-prompt">
      <div class="sage-av">üßô</div>
      <div class="sage-text" id="sage-text">Tap the card to flip it and see the full activity instructions.</div>
    </div>

    <div id="xp-pop" style="display:none;text-align:center;padding:6px 0;font-family:'Fredoka One',cursive;font-size:1.4rem;color:var(--gold);text-shadow:0 0 16px rgba(255,212,71,.5)"></div>

    <div class="card-actions" id="card-actions">
      <button class="btn-did-it" id="btn-done" onclick="markDone()">‚úÖ I Did It!</button>
      <button class="btn-later" onclick="skipCard()">Do This Later</button>
    </div>
  </div>

  <!-- COMPLETE -->
  <div id="screen-complete" style="display:none;flex-direction:column">
    <div class="complete-burst" id="complete-icon">üéâ</div>
    <div class="complete-title" id="complete-title">Mission Complete!</div>
    <div class="complete-sub" id="complete-sub">Great work today. These skills build up ‚Äî one day at a time.</div>
    <div class="score-row">
      <div class="score-chip xp-chip"><span class="sc-n" id="c-xp">0</span><div class="sc-l">XP Earned</div></div>
      <div class="score-chip done-chip"><span class="sc-n" id="c-done">0</span><div class="sc-l">Completed</div></div>
      <div class="score-chip streak-chip"><span class="sc-n" id="c-streak">0</span><div class="sc-l">Day Streak üî•</div></div>
    </div>
    <div class="badge-unlock" id="badge-unlock"></div>
    <div class="complete-actions">
      <button class="btn-again" onclick="location.reload()">New Session</button>
      <button class="btn-home" onclick="location.href='index.html'">Back to Hub</button>
    </div>
  </div>

</div><!-- /app -->
<div id="toast"></div>

<script>
/* ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const TSV = 'question_bank.tsv';
const TA_URL = localStorage.getItem('ff_ta_link') || 'https://claude.ai/project/019c8725-05d6-7317-bd77-475bce4be335';
const CARDS_PER_DAY = 3;
const BOSS_STREAK_THRESHOLD = 5;

const CAT_COLOR = {
  'Executive Function':'#ff5e5e','Working Memory':'#00d4c8','Focus Stamina':'#ffcc00',
  'Impulse Management':'#4cd97b','Emotional Regulation':'#ff7eb3',
  'Real-World Application':'#4da6ff','Technical Planning':'#a278ff'
};
const CAT_ICON = {
  'Executive Function':'üß†','Working Memory':'üíæ','Focus Stamina':'üéØ',
  'Impulse Management':'üõë','Emotional Regulation':'üíõ',
  'Real-World Application':'üåç','Technical Planning':'üìã'
};
const TYPE_ICON = {streak:'üî•',focus_drill:'üéØ',goal_setting:'‚≠ê',reflection:'üí≠'};
const TYPE_LABEL = {streak:'Daily Streak',focus_drill:'Focus Drill',goal_setting:'Goal Setting',reflection:'Reflection'};
const XP_BASE = {1:25,2:35,3:50};
const SAGE_HINTS = {
  'Executive Function':["This is about getting the brain moving in a direction. Even 10% of this activity counts.","Planning activities work best when you write things down ‚Äî externalising is the hack."],
  'Working Memory':["Working memory is like a mental whiteboard. Drills like this gradually increase how much you can hold.","Don't rush ‚Äî speed is less important than accuracy for memory training."],
  'Focus Stamina':["Every time you notice your mind wandering and bring it back ‚Äî that is the exercise.","The goal isn't perfect focus. It's the noticing-and-returning."],
  'Impulse Management':["The pause IS the practice. Even a 2-second pause between urge and action is progress.","There's no failure here ‚Äî noticing an impulse after the fact still builds awareness."],
  'Emotional Regulation':["Naming a feeling reduces its power. You don't have to fix it ‚Äî just name it.","This works best when you're honest. There are no wrong answers."],
  'Real-World Application':["These are the skills that show up in real life. Small consistent practice beats occasional big effort.","Try doing this in the actual context it describes ‚Äî not just as an exercise."],
  'Technical Planning':["Before starting ‚Äî define what done looks like. The clearer the finish line, the easier the task.","Break it smaller than feels necessary. Smaller steps have lower starting resistance."]
};

/* ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const ld=(k,d)=>{try{return JSON.parse(localStorage.getItem('ff_'+k))??d}catch{return d}};
const sv=(k,v)=>localStorage.setItem('ff_'+k,JSON.stringify(v));

let ROWS=[],todayCards=[],currentIdx=0,doneCount=0,sessionXP=0;
let isFlipped=false;
const doneCards=ld('doneCards',{});
const streak=ld('streak',0);
const ageGroup=ld('ageGroup','both');

/* ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function init(){
  show('screen-load');
  try{
    const res=await fetch(TSV);
    if(!res.ok)throw new Error('not found');
    const text=await res.text();
    const lines=text.trim().split('\n');
    ROWS=lines.slice(1).map(l=>l.split('\t'));
    buildDailyCards();
    renderBrief();
    show('screen-brief');
    hide('screen-load');
  }catch(e){
    document.getElementById('screen-load').innerHTML=`
      <div style="font-size:2.5rem;margin-bottom:12px">üìÇ</div>
      <h3>Question bank not found</h3>
      <p>Make sure <strong>question_bank.tsv</strong> is in the same folder as this file.</p>
      <a href="index.html" style="color:#9b6dff;font-weight:700;margin-top:16px;display:inline-block">‚Üê Back to Hub</a>`;
  }
}

/* ‚îÄ‚îÄ DAILY SEED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function seedRand(seed){
  let s=seed;
  return()=>{s=(s*1664525+1013904223)&0xffffffff;return(s>>>0)/0xffffffff};
}
function buildDailyCards(){
  // Date seed ‚Äî same cards all day, resets at midnight
  const dateStr=new Date().toDateString();
  const seed=dateStr.split('').reduce((a,c)=>a+c.charCodeAt(0),0)*31337;
  const rand=seedRand(seed);

  // Filter by age group
  const pool=ROWS.filter(r=>{
    const aud=r[3];
    if(ageGroup==='youth' && aud==='adult')return false;
    if(ageGroup==='adult' && aud==='youth')return false;
    return true;
  });

  // Weight towards unseen cards
  const seen=Object.keys(doneCards);
  const unseen=pool.filter(r=>!seen.includes(r[0]));
  const src=unseen.length>=CARDS_PER_DAY?unseen:pool;

  // Seeded shuffle, pick balanced across categories
  const shuffled=[...src].sort(()=>rand()-.5);
  const cats=new Set();
  const picked=[];
  for(const r of shuffled){
    if(picked.length>=CARDS_PER_DAY)break;
    if(!cats.has(r[1])||cats.size>=CARDS_PER_DAY){
      picked.push(r);cats.add(r[1]);
    }
  }
  // Fallback if not enough variety
  while(picked.length<CARDS_PER_DAY && shuffled.length>picked.length){
    const r=shuffled[picked.length];
    if(!picked.includes(r))picked.push(r);
  }

  // Boss round ‚Äî append if on streak
  if(streak>=BOSS_STREAK_THRESHOLD){
    const bossPool=ROWS.filter(r=>parseInt(r[4])===3&&!picked.includes(r));
    if(bossPool.length){
      const bi=Math.floor(rand()*bossPool.length);
      picked.push({...bossPool[bi],isBoss:true});
    }
  }
  todayCards=picked;
}

/* ‚îÄ‚îÄ BRIEF ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function renderBrief(){
  const now=new Date();
  document.getElementById('brief-date').textContent=
    now.toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long'});
  document.getElementById('brief-title').textContent=
    getGreeting()+' ‚Äî Your Mission';

  // Category preview icons
  document.getElementById('brief-icons').innerHTML=
    todayCards.map((r,i)=>{
      const cat=r[1]||'';
      const cc=CAT_COLOR[cat]||'#9b6dff';
      return`<div class="brief-cat-icon" style="border-color:${cc}40;background:${cc}12">${CAT_ICON[cat]||'‚ö°'}</div>`;
    }).join('');

  // Pips
  renderPips('pips-brief');

  // Boss warning
  if(streak>=BOSS_STREAK_THRESHOLD){
    document.getElementById('boss-warn').style.display='block';
  }
}

function getGreeting(){
  const h=new Date().getHours();
  if(h<12)return'Good Morning';
  if(h<17)return'Good Afternoon';
  return'Good Evening';
}

/* ‚îÄ‚îÄ MISSION START ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function startMission(){
  hide('screen-brief');
  currentIdx=0;
  renderCard(currentIdx);
  show('screen-card');
}

/* ‚îÄ‚îÄ PIPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function renderPips(id){
  const n=todayCards.length;
  document.getElementById(id).innerHTML=todayCards.map((r,i)=>{
    let cls='pip';
    if(r.isBoss)cls+=' boss';
    return`<div class="${cls}" id="pip-${id}-${i}"></div>`;
  }).join('');
  updatePips(id);
}
function updatePips(id){
  todayCards.forEach((_,i)=>{
    const el=document.getElementById(`pip-${id}-${i}`);
    if(!el)return;
    if(i<currentIdx){el.classList.add('done');el.classList.remove('active')}
    else if(i===currentIdx){el.classList.add('active');el.classList.remove('done')}
    else{el.classList.remove('active','done')}
  });
}

/* ‚îÄ‚îÄ RENDER CARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function renderCard(idx){
  if(idx>=todayCards.length){endMission();return}
  const r=todayCards[idx];
  const cat=r[1]||'';
  const cc=CAT_COLOR[cat]||'#9b6dff';
  const diff=parseInt(r[4])||1;
  const typeIcon=TYPE_ICON[r[5]]||'üìå';
  const typeLabel=TYPE_LABEL[r[5]]||r[5];
  const isBoss=r.isBoss;
  const isDone=!!doneCards[r[0]];
  const aud=r[3]==='youth'?'üßí Youth':r[3]==='adult'?'üßë Adult':'All Ages';
  const dots=[1,2,3].map(d=>`<div class="dd${d<=diff?' lit':''}"></div>`).join('');

  // Counter
  document.getElementById('card-counter').textContent=`Card ${idx+1} of ${todayCards.length}`;
  updatePips('pips-card');

  // Reset flip
  isFlipped=false;
  document.getElementById('flipper').classList.remove('flipped');

  // FRONT
  document.getElementById('card-front').style.setProperty('--cc',cc);
  document.getElementById('card-front').innerHTML=`
    <div class="cf-top">
      <span class="cf-cat">${cat}</span>
      <div class="cf-badges">
        <span class="cf-time">‚è± ${r[6]}m</span>
        <span class="cf-type">${typeIcon}</span>
        ${isBoss?'<span class="boss-tag">üëπ Boss</span>':''}
      </div>
    </div>
    <div class="cf-icon-area">
      <div class="cf-big-icon">${CAT_ICON[cat]||'‚ö°'}</div>
    </div>
    <div class="cf-bottom">
      <div class="cf-title">${r[7]}</div>
      <div class="cf-prompt">"${r[8]}"</div>
      <div class="cf-flip-hint">üëÜ Tap to see instructions</div>
    </div>`;

  // BACK
  document.getElementById('card-back').style.setProperty('--cc',cc);
  const mats=r[11]&&r[11]!=='none'?`<div class="cb-mats"><span>üéí</span><span>You'll need: <strong>${r[11]}</strong></span></div>`:'';
  document.getElementById('card-back').innerHTML=`
    <div class="cb-head">
      <span class="cb-section-lbl">${cat} ¬∑ ${r[2]}</span>
      <button class="cb-flip-back" onclick="event.stopPropagation();flipCard()">‚Ü© Flip</button>
    </div>
    <div class="cb-instructions">${r[9]}</div>
    <div class="cb-success"><span class="tick">‚úÖ</span><p>${r[10]}</p></div>
    ${mats}
    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:auto">
      <div class="cb-diff">${dots}</div>
      <span class="cb-aud">${aud}</span>
    </div>`;

  // Sage hint
  const hints=SAGE_HINTS[cat]||['Flip the card to see the full instructions.'];
  const hint=hints[Math.floor(Math.random()*hints.length)];
  document.getElementById('sage-text').innerHTML=`<strong>Sage:</strong> ${hint}`;

  // Done button
  const btn=document.getElementById('btn-done');
  if(isDone){
    btn.textContent='‚úì Already Done';
    btn.style.background='rgba(92,255,143,.15)';
    btn.style.color='#5cff8f';
    btn.style.boxShadow='none';
    btn.style.border='1px solid rgba(92,255,143,.3)';
  } else {
    btn.textContent='‚úÖ I Did It!';
    btn.style.background='linear-gradient(135deg,var(--lime),var(--teal))';
    btn.style.color='#062010';
    btn.style.boxShadow='0 4px 20px rgba(92,255,143,.25)';
    btn.style.border='none';
  }

  renderPips('pips-card');
}

function flipCard(){
  isFlipped=!isFlipped;
  document.getElementById('flipper').classList.toggle('flipped',isFlipped);
  if(isFlipped){
    document.getElementById('sage-text').innerHTML=
      `<strong>Sage:</strong> Read the instructions, then go do the activity in real life. Come back and tap <em>"I Did It!"</em> when you're done.`;
  }
}

/* ‚îÄ‚îÄ MARK DONE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function markDone(){
  const r=todayCards[currentIdx];
  const isBoss=r.isBoss;
  const base=XP_BASE[parseInt(r[4])||1]||25;
  const xp=isBoss?base*3:base;

  // Save
  doneCards[r[0]]=Date.now();
  sv('doneCards',doneCards);
  doneCount++;
  sessionXP+=xp;

  // Write back to shared state
  writeSharedState(xp,'daily',r[7],r[1],r[0],null);

  // XP pop
  const pop=document.getElementById('xp-pop');
  pop.textContent=`+${xp} XP ${isBoss?'üî• BOSS!':''}`;
  pop.style.display='block';
  setTimeout(()=>{pop.style.display='none';nextCard()},900);

  showToast(`‚ö° +${xp} XP${isBoss?' ‚Äî Boss slain! üíÄ':''}`)
}

function skipCard(){
  showToast('Saved for later ‚Äî you can do it off-screen anytime.');
  nextCard();
}

function nextCard(){
  currentIdx++;
  if(currentIdx>=todayCards.length){endMission();return}
  renderCard(currentIdx);
}

/* ‚îÄ‚îÄ END ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function endMission(){
  // Bonus XP for full completion
  if(doneCount===todayCards.length && doneCount>0){
    sessionXP+=50;
    writeSharedState(50,'daily','Full mission bonus',null,null,null);
    showToast('üéâ Full mission completed! +50 bonus XP');
  }

  document.getElementById('complete-icon').textContent=
    doneCount>0?'üéâ':'üåô';
  document.getElementById('complete-title').textContent=
    doneCount===todayCards.length?'Mission Complete!':
    doneCount>0?'Good effort today!':'See you next time!';
  document.getElementById('complete-sub').textContent=
    doneCount===todayCards.length?
    'Full mission done. These skills build up ‚Äî one day at a time.':
    doneCount>0?
    'You completed some activities today. Every one counts ‚Äî come back for the rest anytime.':
    'Not every day is a mission day. The activities will be here when you are.';

  document.getElementById('c-xp').textContent=sessionXP;
  document.getElementById('c-done').textContent=doneCount;
  document.getElementById('c-streak').textContent=ld('streak',0);

  hide('screen-card');
  show('screen-complete');
}

/* ‚îÄ‚îÄ SHARED STATE WRITE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function writeSharedState(xpAmt,mode,label,cat,cardId,score){
  // Mirror of FF.awardXP in index.html ‚Äî write directly to localStorage
  let xp=ld('xp',0);const prevLv=getLv(xp);
  xp+=xpAmt;sv('xp',xp);
  let sess=ld('sessions',0)+1;sv('sessions',sess);
  const today=new Date().toDateString();
  let str=ld('streak',0),ld2=ld('lastDate','');
  if(ld2!==today){
    const yest=new Date(Date.now()-86400000).toDateString();
    str=(ld2===yest)?str+1:1;
    sv('streak',str);sv('lastDate',today);
  }
  if(cat){const dc=ld('doneCats',{});dc[cat]=(dc[cat]||0)+1;sv('doneCats',dc)}
  if(cardId){const d=ld('doneCards',{});d[cardId]=Date.now();sv('doneCards',d)}
  const hist=ld('history',[]);
  hist.push({ts:Date.now(),mode,label,cat,cardId,xp:xpAmt,score,level:getLv(xp).n});
  sv('history',hist);
}

function getLv(v){
  const LEVELS=[
    {n:1,xp:0},{n:2,xp:150},{n:3,xp:400},{n:4,xp:750},
    {n:5,xp:1200},{n:6,xp:1800},{n:7,xp:2600},{n:8,xp:3600}
  ];
  let l=LEVELS[0];for(const x of LEVELS){if(v>=x.xp)l=x;else break}return l;
}

/* ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function show(id){const el=document.getElementById(id);el.style.display='flex'}
function hide(id){document.getElementById(id).style.display='none'}

let toastT;
function showToast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');
  clearTimeout(toastT);toastT=setTimeout(()=>el.classList.remove('show'),3000);
}

function openTA(){
  window.open(TA_URL+'?context=daily_mission','_blank');
}

init();
</script>
</body>
</html>
