<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FocusForge ‚Äî Training Game</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Exo+2:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#07090f;--surface:#111625;--surface2:#181e30;--surface3:#1f263d;
  --border:rgba(255,255,255,0.07);--border2:rgba(255,255,255,0.14);
  --text:#dde3f5;--muted:#5a6585;--muted2:#8591b0;
  --gold:#ffd447;--teal:#00e5cc;--rose:#ff5e7d;--lime:#5cff8f;--violet:#9b6dff;--amber:#ff9a3c;
  --cat-ef:#ff5e5e;--cat-wm:#00d4c8;--cat-fs:#ffcc00;--cat-im:#4cd97b;
  --cat-er:#ff7eb3;--cat-rw:#4da6ff;--cat-tp:#a278ff;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Exo 2',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
button{font-family:'Exo 2',sans-serif;cursor:pointer}
body::before{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:radial-gradient(ellipse 70% 50% at 70% 20%,rgba(0,229,204,.05) 0%,transparent 60%),
  radial-gradient(ellipse 60% 40% at 20% 80%,rgba(155,109,255,.06) 0%,transparent 60%)}

.app{position:relative;z-index:1;max-width:700px;margin:0 auto;padding:0 20px 80px;min-height:100vh;display:flex;flex-direction:column}

/* NAV */
nav{display:flex;align-items:center;justify-content:space-between;padding:22px 0 28px}
.nav-back{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:.82rem;font-weight:700;text-decoration:none;transition:color .15s}
.nav-back:hover{color:var(--text)}
.nav-title{font-family:'Fredoka One',cursive;font-size:1.1rem;color:var(--muted2)}
.btn-ta-sm{display:flex;align-items:center;gap:6px;background:var(--surface2);border:1px solid rgba(155,109,255,.3);border-radius:50px;padding:7px 14px;color:#c4b5fd;font-size:.76rem;font-weight:700;transition:all .15s}
.btn-ta-sm:hover{border-color:rgba(155,109,255,.6);background:rgba(155,109,255,.12)}
.ta-dot{width:6px;height:6px;border-radius:50%;background:var(--lime);box-shadow:0 0 6px var(--lime);animation:pd 2s infinite}
@keyframes pd{0%,100%{opacity:1}50%{opacity:.4}}

/* ‚îÄ‚îÄ MODE SELECT ‚îÄ‚îÄ */
#screen-mode{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;animation:fadeUp .4s ease both}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.mode-header{text-align:center;margin-bottom:32px}
.mode-header .lbl{font-size:.68rem;text-transform:uppercase;letter-spacing:3px;color:var(--teal);font-weight:700;margin-bottom:8px}
.mode-header h2{font-family:'Fredoka One',cursive;font-size:2rem;margin-bottom:8px}
.mode-header p{font-size:.84rem;color:var(--muted2);line-height:1.6;max-width:420px}

.mode-cards{display:grid;grid-template-columns:1fr 1fr;gap:14px;width:100%;max-width:560px;margin-bottom:24px}
.mode-card{padding:22px 18px;background:var(--surface);border:1.5px solid var(--border);border-radius:20px;text-align:center;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.mode-card::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 50% 0%,color-mix(in srgb,var(--mc,#9b6dff) 15%,transparent) 0%,transparent 70%);opacity:0;transition:opacity .2s}
.mode-card:hover{border-color:color-mix(in srgb,var(--mc,#9b6dff) 50%,transparent);transform:translateY(-3px)}
.mode-card:hover::before{opacity:1}
.mode-card.locked{opacity:.45;cursor:not-allowed}
.mode-card.locked:hover{transform:none}
.mc-icon{font-size:2.2rem;margin-bottom:10px;display:block}
.mc-name{font-family:'Fredoka One',cursive;font-size:1.05rem;margin-bottom:5px}
.mc-desc{font-size:.74rem;color:var(--muted2);line-height:1.5}
.mc-lock{position:absolute;top:10px;right:10px;font-size:.68rem;color:var(--muted);font-weight:700;background:var(--surface3);border-radius:50px;padding:2px 8px}
.mode-card:nth-child(1){--mc:var(--teal)}
.mode-card:nth-child(2){--mc:var(--violet)}
.mode-card:nth-child(3){--mc:var(--gold)}
.mode-card:nth-child(4){--mc:var(--rose)}

.cat-selector{width:100%;max-width:560px;margin-bottom:8px;display:none}
.cat-selector label{font-size:.7rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-weight:700;display:block;margin-bottom:8px}
.cat-chips{display:flex;flex-wrap:wrap;gap:7px}
.cat-chip{padding:6px 14px;border-radius:50px;font-size:.76rem;font-weight:700;border:1.5px solid var(--border);background:var(--surface2);color:var(--muted);transition:all .15s}
.cat-chip.on{color:#07090f;border-color:transparent}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
#screen-load{flex:1;display:none;flex-direction:column;align-items:center;justify-content:center;gap:16px;text-align:center}
.loader{width:44px;height:44px;border-radius:50%;border:3px solid var(--surface2);border-top-color:var(--teal);animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ‚îÄ‚îÄ GAME SCREEN ‚îÄ‚îÄ */
#screen-game{flex:1;display:none;flex-direction:column}

/* Top bar */
.game-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px}
.gt-left{display:flex;align-items:center;gap:12px}
.q-counter{font-family:'Fredoka One',cursive;font-size:1.1rem;color:var(--muted2)}
.combo-badge{background:rgba(255,154,60,.15);border:1px solid rgba(255,154,60,.3);border-radius:50px;padding:4px 12px;font-size:.76rem;font-weight:800;color:var(--amber);display:none}
.combo-badge.show{display:inline-block;animation:popIn .2s ease both}
@keyframes popIn{from{transform:scale(.7)}to{transform:scale(1)}}
.gt-right{display:flex;align-items:center;gap:10px}
.xp-tally{font-family:'Fredoka One',cursive;font-size:1rem;color:var(--gold)}
.hint-btn{background:var(--surface2);border:1px solid var(--border2);border-radius:50px;padding:5px 13px;font-size:.74rem;color:var(--muted2);font-weight:700;transition:all .15s}
.hint-btn:hover:not(:disabled){color:var(--text);border-color:rgba(255,255,255,.2)}
.hint-btn:disabled{opacity:.35;cursor:not-allowed}

/* Timer ring */
.timer-wrap{display:flex;justify-content:center;margin-bottom:20px;position:relative}
.timer-ring{transform:rotate(-90deg)}
.timer-track{fill:none;stroke:var(--surface2);stroke-width:5}
.timer-fill{fill:none;stroke:var(--teal);stroke-width:5;stroke-linecap:round;transition:stroke-dashoffset .9s linear, stroke .3s}
.timer-num{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Fredoka One',cursive;font-size:1.4rem;color:var(--teal);transition:color .3s}

/* Question card */
.q-card{background:var(--surface);border:1px solid var(--border2);border-radius:24px;padding:26px;margin-bottom:18px;position:relative;overflow:hidden;animation:slideIn .3s ease both}
@keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
.q-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--cc,#00e5cc),transparent);opacity:.7}
.q-cat-row{display:flex;align-items:center;gap:8px;margin-bottom:14px}
.q-cat-pill{font-size:.65rem;text-transform:uppercase;letter-spacing:1.5px;font-weight:800;padding:4px 11px;border-radius:50px;background:color-mix(in srgb,var(--cc,#00e5cc) 12%,transparent);color:var(--cc,#00e5cc);border:1px solid color-mix(in srgb,var(--cc,#00e5cc) 28%,transparent)}
.q-diff{display:flex;gap:3px;align-items:center}
.dd{width:7px;height:7px;border-radius:50%;background:var(--surface3)}
.dd.lit{background:var(--cc,#00e5cc);box-shadow:0 0 4px var(--cc,#00e5cc)}
.boss-tag{font-size:.65rem;font-weight:800;color:var(--rose);background:rgba(255,94,125,.12);border:1px solid rgba(255,94,125,.3);border-radius:50px;padding:2px 9px;text-transform:uppercase;letter-spacing:1px}
.q-text{font-size:1rem;font-weight:700;line-height:1.6;color:var(--text)}
.q-generated{display:flex;align-items:center;gap:8px;margin-top:12px;padding:10px 14px;background:var(--surface2);border-radius:12px;border:1px dashed rgba(0,229,204,.25)}
.qg-label{font-size:.65rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--teal);font-weight:700;flex-shrink:0}
.qg-value{font-family:'Fredoka One',cursive;font-size:.95rem;color:var(--text);letter-spacing:.5px}
.hint-box{margin-top:12px;padding:11px 14px;background:rgba(255,212,71,.07);border:1px solid rgba(255,212,71,.22);border-radius:12px;font-size:.8rem;color:#ffe082;line-height:1.5;display:none;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

/* Answer options */
.options{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.opt{padding:15px 14px;background:var(--surface2);border:1.5px solid var(--border);border-radius:16px;font-size:.88rem;font-weight:700;color:var(--text);text-align:left;transition:all .18s;position:relative;overflow:hidden;line-height:1.4}
.opt::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 50% 0%,rgba(155,109,255,.12) 0%,transparent 70%);opacity:0;transition:opacity .15s}
.opt:hover:not(:disabled){border-color:var(--border2);transform:translateY(-1px)}
.opt:hover:not(:disabled)::before{opacity:1}
.opt.correct{background:rgba(92,255,143,.12);border-color:var(--lime);color:var(--lime);animation:correctPop .3s ease both}
@keyframes correctPop{from{transform:scale(.97)}to{transform:scale(1)}}
.opt.wrong{background:rgba(255,94,125,.1);border-color:var(--rose);color:var(--rose)}
.opt.reveal{background:rgba(92,255,143,.06);border-color:rgba(92,255,143,.3);color:#8de8a4}
.opt:disabled{cursor:default;transform:none}
.opt-letter{display:inline-block;width:22px;height:22px;border-radius:6px;background:var(--surface3);font-size:.72rem;font-weight:900;text-align:center;line-height:22px;margin-right:8px;flex-shrink:0}
.opt.correct .opt-letter{background:var(--lime);color:#062010}
.opt.wrong .opt-letter{background:var(--rose);color:#fff}

/* Feedback bar */
.feedback{padding:14px 18px;border-radius:14px;margin-bottom:14px;display:none;animation:fadeUp .25s ease both;font-size:.84rem;line-height:1.55}
.feedback.correct{background:rgba(92,255,143,.08);border:1px solid rgba(92,255,143,.25);color:#8de8a4}
.feedback.wrong{background:rgba(255,94,125,.08);border:1px solid rgba(255,94,125,.25);color:#ffb3c1}
.feedback strong{color:var(--text)}

/* XP flash */
.xp-flash{text-align:center;font-family:'Fredoka One',cursive;font-size:1.6rem;color:var(--gold);text-shadow:0 0 16px rgba(255,212,71,.5);display:none;animation:xpPop .5s ease both;padding:4px 0}
@keyframes xpPop{from{opacity:0;transform:scale(.5) translateY(8px)}to{opacity:1;transform:scale(1) translateY(0)}}

.btn-next{width:100%;padding:14px;background:linear-gradient(135deg,var(--teal),var(--violet));border:none;border-radius:14px;color:#fff;font-weight:900;font-size:.92rem;display:none;animation:fadeUp .3s ease both;transition:filter .15s}
.btn-next:hover{filter:brightness(1.1)}

/* Sage box */
.sage-box{display:flex;gap:10px;align-items:flex-start;padding:12px 14px;background:rgba(155,109,255,.07);border:1px solid rgba(155,109,255,.18);border-radius:14px;margin-bottom:16px}
.sage-av{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--violet),var(--teal));display:flex;align-items:center;justify-content:center;font-size:.85rem;flex-shrink:0}
.sage-txt{font-size:.76rem;color:var(--muted2);line-height:1.55}
.sage-txt strong{color:var(--text)}

/* ‚îÄ‚îÄ RESULTS SCREEN ‚îÄ‚îÄ */
#screen-result{flex:1;display:none;flex-direction:column;align-items:center;justify-content:center;text-align:center;animation:fadeUp .4s ease both}
.result-icon{font-size:4rem;margin-bottom:14px;display:block}
.result-title{font-family:'Fredoka One',cursive;font-size:2rem;margin-bottom:8px}
.result-sub{font-size:.86rem;color:var(--muted2);line-height:1.6;max-width:420px;margin-bottom:28px}

.score-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;width:100%;max-width:500px;margin-bottom:24px}
.sg-chip{padding:14px 10px;border-radius:16px;text-align:center}
.sg-chip.xp{background:rgba(255,212,71,.1);border:1px solid rgba(255,212,71,.3)}
.sg-chip.acc{background:rgba(0,229,204,.08);border:1px solid rgba(0,229,204,.25)}
.sg-chip.time{background:rgba(155,109,255,.08);border:1px solid rgba(155,109,255,.25)}
.sg-n{font-family:'Fredoka One',cursive;font-size:1.8rem;display:block}
.sg-l{font-size:.64rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-top:3px;font-weight:600}
.sg-chip.xp .sg-n{color:var(--gold)}
.sg-chip.acc .sg-n{color:var(--teal)}
.sg-chip.time .sg-n{color:var(--violet)}

.cat-breakdown{width:100%;max-width:500px;margin-bottom:24px;text-align:left}
.cat-breakdown h4{font-size:.7rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-weight:700;margin-bottom:10px}
.cb-row{display:flex;align-items:center;gap:10px;margin-bottom:7px}
.cb-icon{font-size:.9rem;width:22px;text-align:center;flex-shrink:0}
.cb-label{font-size:.76rem;font-weight:700;flex:1;color:var(--muted2)}
.cb-score{font-size:.74rem;font-weight:800;color:var(--text)}

.result-actions{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
.btn-replay{padding:13px 30px;background:linear-gradient(135deg,var(--teal),var(--violet));border:none;border-radius:50px;color:#fff;font-weight:900;font-size:.9rem;transition:all .2s}
.btn-replay:hover{transform:translateY(-2px);filter:brightness(1.1)}
.btn-home{padding:13px 24px;background:var(--surface2);border:1px solid var(--border2);border-radius:50px;color:var(--muted2);font-weight:700;font-size:.88rem;transition:all .15s}
.btn-home:hover{color:var(--text)}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
#toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(30px);background:var(--surface2);border:1px solid var(--border2);border-radius:50px;padding:10px 20px;font-size:.82rem;font-weight:700;color:var(--text);z-index:300;pointer-events:none;white-space:nowrap;transition:transform .28s,opacity .28s;opacity:0;box-shadow:0 8px 32px rgba(0,0,0,.5)}
#toast.show{transform:translateX(-50%) translateY(0);opacity:1}

::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:2px}

@media(max-width:500px){
  .mode-cards{grid-template-columns:1fr}
  .options{grid-template-columns:1fr}
  .score-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="app">

<nav>
  <a class="nav-back" href="index.html">‚Üê Hub</a>
  <span class="nav-title">Training Game</span>
  <button class="btn-ta-sm" onclick="openTA()"><div class="ta-dot"></div>Ask Sage</button>
</nav>

<!-- MODE SELECT -->
<div id="screen-mode">
  <div class="mode-header">
    <div class="lbl">Choose Your Training</div>
    <h2>Training Game</h2>
    <p>Every session is different ‚Äî questions are randomised fresh each time. No memorising your way through.</p>
  </div>
  <div class="mode-cards">
    <div class="mode-card" onclick="startMode('quick')">
      <span class="mc-icon">‚ö°</span>
      <div class="mc-name">Quick Play</div>
      <div class="mc-desc">5 random questions. Fast session across all categories.</div>
    </div>
    <div class="mode-card" onclick="startMode('focused')">
      <span class="mc-icon">üéØ</span>
      <div class="mc-name">Focused</div>
      <div class="mc-desc">Pick one category. 5 questions from that skill.</div>
    </div>
    <div class="mode-card" onclick="startMode('endurance')">
      <span class="mc-icon">üîã</span>
      <div class="mc-name">Endurance</div>
      <div class="mc-desc">10 questions. Full mix. More XP.</div>
    </div>
    <div class="mode-card" id="boss-mode-card" onclick="startMode('boss')">
      <span class="mc-icon">üëπ</span>
      <div class="mc-name">Boss Challenge</div>
      <div class="mc-desc">Hard difficulty only. Triple XP. Unlocks at Level 5.</div>
    </div>
  </div>
  <div class="cat-selector" id="cat-selector">
    <label>Choose a category</label>
    <div class="cat-chips" id="cat-chips"></div>
  </div>
</div>

<!-- LOADING -->
<div id="screen-load">
  <div class="loader"></div>
  <p style="font-size:.84rem;color:var(--muted)">Loading question bank‚Ä¶</p>
</div>

<!-- GAME -->
<div id="screen-game">
  <div class="game-top">
    <div class="gt-left">
      <span class="q-counter" id="q-counter">Q 1 / 5</span>
      <span class="combo-badge" id="combo-badge">üî• 2√ó Combo</span>
    </div>
    <div class="gt-right">
      <span class="xp-tally" id="xp-tally">+0 XP</span>
      <button class="hint-btn" id="hint-btn" onclick="useHint()">üí° Hint (-5 XP)</button>
    </div>
  </div>

  <!-- Timer -->
  <div class="timer-wrap">
    <svg class="timer-ring" width="80" height="80" viewBox="0 0 80 80">
      <circle class="timer-track" cx="40" cy="40" r="34"/>
      <circle class="timer-fill" id="timer-fill" cx="40" cy="40" r="34" stroke-dasharray="213.6" stroke-dashoffset="0"/>
    </svg>
    <div class="timer-num" id="timer-num">20</div>
  </div>

  <!-- Question -->
  <div class="q-card" id="q-card">
    <div class="q-cat-row">
      <span class="q-cat-pill" id="q-cat-pill">Category</span>
      <div class="q-diff" id="q-diff"></div>
      <span class="boss-tag" id="boss-tag" style="display:none">üëπ Boss</span>
    </div>
    <div class="q-text" id="q-text">Loading‚Ä¶</div>
    <div class="q-generated" id="q-generated" style="display:none">
      <span class="qg-label">Data</span>
      <span class="qg-value" id="qg-value"></span>
    </div>
    <div class="hint-box" id="hint-box"></div>
  </div>

  <div class="options" id="options"></div>
  <div class="feedback" id="feedback"></div>
  <div class="xp-flash" id="xp-flash"></div>
  <button class="btn-next" id="btn-next" onclick="nextQuestion()">Next Question ‚Üí</button>

  <div class="sage-box">
    <div class="sage-av">üßô</div>
    <div class="sage-txt" id="sage-txt"><strong>Sage:</strong> Read carefully ‚Äî some questions need you to look at the generated data above the options.</div>
  </div>
</div>

<!-- RESULTS -->
<div id="screen-result">
  <span class="result-icon" id="r-icon">üéÆ</span>
  <div class="result-title" id="r-title">Session Complete!</div>
  <div class="result-sub" id="r-sub">Good session. Every question you attempt builds the skill ‚Äî right or wrong.</div>
  <div class="score-grid">
    <div class="sg-chip xp"><span class="sg-n" id="r-xp">0</span><div class="sg-l">XP Earned</div></div>
    <div class="sg-chip acc"><span class="sg-n" id="r-acc">0%</span><div class="sg-l">Accuracy</div></div>
    <div class="sg-chip time"><span class="sg-n" id="r-time">0s</span><div class="sg-l">Avg Time</div></div>
  </div>
  <div class="cat-breakdown" id="cat-breakdown"></div>
  <div class="result-actions">
    <button class="btn-replay" onclick="location.reload()">Play Again</button>
    <button class="btn-home" onclick="location.href='index.html'">Back to Hub</button>
  </div>
</div>

</div><!-- /app -->
<div id="toast"></div>

<script>
/* ‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const GAME_TSV = 'game_bank.tsv';
const TA_URL = localStorage.getItem('ff_ta_link') || 'https://claude.ai/project/019c8725-05d6-7317-bd77-475bce4be335';

const CAT_COLOR={'Executive Function':'#ff5e5e','Working Memory':'#00d4c8','Focus Stamina':'#ffcc00',
  'Impulse Management':'#4cd97b','Emotional Regulation':'#ff7eb3',
  'Real-World Application':'#4da6ff','Technical Planning':'#a278ff'};
const CAT_ICON={'Executive Function':'üß†','Working Memory':'üíæ','Focus Stamina':'üéØ',
  'Impulse Management':'üõë','Emotional Regulation':'üíõ','Real-World Application':'üåç','Technical Planning':'üìã'};
const CATS=Object.keys(CAT_COLOR);

/* Column indices */
const F={id:0,cat:1,sub:2,aud:3,diff:4,tmpl:5,vars:6,correct:7,distract:8,
         fmt:9,xp:10,secs:11,boss:12,hint:13,explain:14,tags:15};

/* Variable pools */
const POOLS={
  WORDS:['apple','bridge','cloud','dancer','engine','forest','guitar','harbour','island','jacket',
    'kettle','lantern','mirror','needle','ocean','pencil','quilt','rocket','silver','thunder',
    'umbrella','valley','whisper','xylophone','yellow','zebra','anchor','basket','candle','diamond',
    'emerald','feather','garden','hollow','iron','jungle','kitten','lemon','marble','noodle',
    'orange','puzzle','rabbit','shadow','tunnel','upper','violet','walnut','yogurt','zipper'],
  NUMBERS:()=>{const a=[];for(let i=0;i<6;i++)a.push(Math.floor(Math.random()*9)+1);return a},
  NAMES:['Alex','Sam','Jordan','Casey','Riley','Morgan','Taylor','Jamie','Quinn','Avery',
    'Blake','Charlie','Dana','Elliot','Frankie','Grey','Harper','Indigo','Jesse','Kai'],
  PLACES:['the park','the library','school','the shops','a friend\'s house','the sports centre','home'],
  OBJECTS:['book','water bottle','phone','pencil case','backpack','lunchbox','keys','notebook','charger','hat'],
  EMOTIONS:['happy','frustrated','anxious','proud','disappointed','excited','calm','overwhelmed','grateful','confused'],
  SCENARIOS:['you forgot to do your homework','the Wi-Fi stopped working','your friend cancelled plans',
    'you got a question wrong in class','the queue is moving very slowly','someone took your seat'],
  TASKS:['write an email','tidy your desk','prepare for a meeting','read a chapter','complete a form','pack a bag'],
  COLOURS:['red','blue','green','yellow','purple','orange','pink','white','black','silver'],
};

function rnd(arr){return arr[Math.floor(Math.random()*arr.length)]}
function rndN(n,arr){const s=[...arr];const r=[];while(r.length<n&&s.length)r.push(s.splice(Math.floor(Math.random()*s.length),1)[0]);return r}
function rndInt(min,max){return Math.floor(Math.random()*(max-min+1))+min}

/* ‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const ld=(k,d)=>{try{return JSON.parse(localStorage.getItem('ff_'+k))??d}catch{return d}};
const sv=(k,v)=>localStorage.setItem('ff_'+k,JSON.stringify(v));

let ROWS=[],sessionQ=[],qIdx=0,sessionXP=0;
let correct=0,hintUsed=0,timeTaken=[],combo=0;
let timerInterval=null,timerLeft=0;
let selMode='quick',selCat=null;
let catStats={};
let hintShown=false;
const level=getLv(ld('xp',0)).n;

/* ‚ïê‚ïê BOOT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.addEventListener('DOMContentLoaded',async()=>{
  // Boss mode lock
  const bossCard=document.getElementById('boss-mode-card');
  if(level<5){
    bossCard.classList.add('locked');
    bossCard.innerHTML+=`<span class="mc-lock">üîí LV 5</span>`;
  }
  buildCatChips();
  show('screen-mode');
});

async function loadTSV(){
  show('screen-load');hide('screen-mode');
  try{
    const res=await fetch(GAME_TSV);
    if(!res.ok)throw new Error();
    const text=await res.text();
    ROWS=text.trim().split('\n').slice(1).map(l=>l.split('\t'));
    buildSession();
    hide('screen-load');
    renderQuestion();
    show('screen-game');
  }catch{
    document.getElementById('screen-load').innerHTML=`
      <div style="font-size:2.5rem;margin-bottom:12px">üìÇ</div>
      <h3 style="font-family:'Fredoka One',cursive;font-size:1.4rem">game_bank.tsv not found</h3>
      <p style="font-size:.84rem;color:var(--muted)">Place game_bank.tsv in the same folder.</p>
      <a href="index.html" style="color:#9b6dff;font-weight:700;margin-top:16px;display:inline-block">‚Üê Back</a>`;
  }
}

/* ‚ïê‚ïê MODE SELECT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildCatChips(){
  const chips=document.getElementById('cat-chips');
  chips.innerHTML=CATS.map(c=>{
    const cc=CAT_COLOR[c];
    return`<div class="cat-chip" data-cat="${c}" style="color:${cc};border-color:${cc}40"
      onclick="selectCat(this,'${c}')">${CAT_ICON[c]} ${c}</div>`;
  }).join('');
}
function selectCat(el,cat){
  selCat=cat;
  document.querySelectorAll('.cat-chip').forEach(c=>c.classList.remove('on'));
  const cc=CAT_COLOR[cat];
  el.classList.add('on');
  el.style.background=cc;el.style.color='#07090f';
}

function startMode(mode){
  if(mode==='boss'&&level<5){toast('üîí Boss mode unlocks at Level 5!');return}
  selMode=mode;
  if(mode==='focused'){
    const sel=document.getElementById('cat-selector');
    sel.style.display='block';
    if(!selCat){toast('Choose a category first!');return}
  }
  loadTSV();
}

/* ‚ïê‚ïê BUILD SESSION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildSession(){
  let pool=ROWS;
  const Q_COUNT=selMode==='endurance'?10:5;

  // Filter
  if(selMode==='focused'&&selCat) pool=pool.filter(r=>r[F.cat]===selCat);
  if(selMode==='boss') pool=pool.filter(r=>r[F.boss]==='true');
  else if(selMode!=='boss') pool=pool.filter(r=>r[F.boss]!=='true');

  // Shuffle
  const shuffled=[...pool].sort(()=>Math.random()-.5);
  sessionQ=shuffled.slice(0,Math.min(Q_COUNT,shuffled.length));

  // Init cat stats
  CATS.forEach(c=>{catStats[c]={a:0,t:0}});
}

/* ‚ïê‚ïê RENDER QUESTION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderQuestion(){
  if(qIdx>=sessionQ.length){endSession();return}
  const r=sessionQ[qIdx];
  hintShown=false;

  const cat=r[F.cat]||'';
  const cc=CAT_COLOR[cat]||'#00e5cc';
  const diff=parseInt(r[F.diff])||1;
  const secs=parseInt(r[F.secs])||20;
  const isBoss=r[F.boss]==='true';

  // Counter
  document.getElementById('q-counter').textContent=`Q ${qIdx+1} / ${sessionQ.length}`;

  // Card meta
  document.getElementById('q-card').style.setProperty('--cc',cc);
  document.getElementById('q-cat-pill').textContent=cat;
  document.getElementById('q-cat-pill').style.setProperty('color',cc);
  document.getElementById('q-cat-pill').style.background=`color-mix(in srgb,${cc} 12%,transparent)`;
  document.getElementById('q-cat-pill').style.border=`1px solid color-mix(in srgb,${cc} 28%,transparent)`;
  document.getElementById('boss-tag').style.display=isBoss?'inline-block':'none';
  const dots=[1,2,3].map(d=>`<div class="dd${d<=diff?' lit':''}"></div>`).join('');
  document.getElementById('q-diff').innerHTML=dots;

  // Inject variables, build question + options
  const {qText, injected, correctAns, options} = buildQuestion(r);

  document.getElementById('q-text').textContent=qText;

  // Show injected data box if there is injected data
  const genBox=document.getElementById('q-generated');
  if(injected){
    genBox.style.display='flex';
    document.getElementById('qg-value').textContent=injected;
  } else {
    genBox.style.display='none';
  }

  // Hint
  document.getElementById('hint-box').style.display='none';
  document.getElementById('hint-btn').disabled=false;
  document.getElementById('hint-box').textContent='üí° '+r[F.hint];

  // Options
  const letters=['A','B','C','D'];
  const shuffledOpts=shuffle([...options]);
  document.getElementById('options').innerHTML=shuffledOpts.map((opt,i)=>`
    <button class="opt" onclick="answer(this,'${escQ(opt)}','${escQ(correctAns)}','${escQ(r[F.explain]||'')}',${parseInt(r[F.xp])||10})">
      <span class="opt-letter">${letters[i]}</span>${opt}
    </button>`).join('');

  // Feedback / flash hidden
  document.getElementById('feedback').style.display='none';
  document.getElementById('xp-flash').style.display='none';
  document.getElementById('btn-next').style.display='none';

  // Sage tip
  const tips={
    1:'Take your time with this one.',
    2:'Look at the data carefully before choosing.',
    3:'This is a harder question ‚Äî think it through step by step.'
  };
  document.getElementById('sage-txt').innerHTML=`<strong>Sage:</strong> ${tips[diff]||tips[1]}`;

  // Combo badge
  const cb=document.getElementById('combo-badge');
  if(combo>=2){cb.textContent=`üî• ${combo}√ó Combo`;cb.classList.add('show')}
  else{cb.classList.remove('show')}

  // Timer
  startTimer(secs,cc);
}

/* ‚ïê‚ïê VARIABLE INJECTION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildQuestion(r){
  const tmpl=r[F.tmpl]||'';
  const varSlots=(r[F.vars]||'').split(',').map(v=>v.trim()).filter(Boolean);
  const correctLogic=r[F.correct]||'';
  const distractorLogic=r[F.distract]||'';
  const fmt=r[F.fmt]||'word';

  let injected='';
  let correctAns='';
  let distractors=[];
  let qText=tmpl;

  // Handle each variable type
  let genWords=[],genNumbers=[],genName='',genScenario='',genTask='',genColour='',genColour2='';

  varSlots.forEach(slot=>{
    const m=slot.match(/^WORDS_(\d+)$/);
    const mn=slot.match(/^NUMBERS_(\d+)(_ARITHMETIC(_GAP)?|_MULTIPLY)?$/);
    const md=slot.match(/^DIGITS_(\d+)$/);

    if(m){
      const n=parseInt(m[1]);
      genWords=rndN(n,POOLS.WORDS);
      injected=genWords.join(', ');
      qText=qText.replace(/\{\{WORDS_\d+\}\}/,injected);
    }
    else if(mn){
      const n=Math.min(parseInt(mn[1]),6);
      const step=rndInt(2,6);
      const start=rndInt(1,20);
      genNumbers=Array.from({length:n},(_,i)=>start+i*step);
      const suffix=mn[2]||'';
      if(suffix.includes('GAP')){
        const gapIdx=rndInt(1,n-2);
        const withGap=[...genNumbers];
        withGap[gapIdx]='__?__';
        injected=withGap.join(', ');
        correctAns=String(genNumbers[gapIdx]);
      } else {
        injected=genNumbers.join(', ');
        if(suffix.includes('MULTIPLY')){
          const mstep=rndInt(2,3);
          genNumbers=Array.from({length:n},(_,i)=>Math.pow(mstep,i+1));
          injected=genNumbers.join(', ');
          correctAns=String(genNumbers[n-1]*mstep);
        } else {
          correctAns=String(genNumbers[n-1]+step);
        }
      }
      qText=qText.replace(/\{\{NUMBERS_\d+[^}]*\}\}/,injected);
      qText=qText.replace(/\{\{SEQ_WITH_GAP\}\}/,injected);
    }
    else if(md){
      const n=parseInt(md[1]);
      const digs=Array.from({length:n},()=>rndInt(0,9));
      genWords=digs.map(String);
      injected=digs.join('-');
      const rev=[...digs].reverse().join('-');
      qText=qText.replace(/\{\{DIGITS_\d+\}\}/,injected);
      if(correctLogic.includes('reversed')) correctAns=rev;
      else correctAns=digs.join('-');
    }
    else if(slot==='NAME'){genName=rnd(POOLS.NAMES);qText=qText.replace(/\{\{NAME\}\}/g,genName)}
    else if(slot==='NAME2'){const n2=rnd(POOLS.NAMES);qText=qText.replace(/\{\{NAME2\}\}/g,n2)}
    else if(slot==='PLACE'){qText=qText.replace(/\{\{PLACE\}\}/g,rnd(POOLS.PLACES))}
    else if(slot==='OBJECT'){const o=rnd(POOLS.OBJECTS);qText=qText.replace(/\{\{OBJECT\}\}/,o)}
    else if(slot==='OBJECT2'){const o2=rnd(POOLS.OBJECTS);qText=qText.replace(/\{\{OBJECT2\}\}/,o2)}
    else if(slot==='SCENARIO'){genScenario=rnd(POOLS.SCENARIOS);qText=qText.replace(/\{\{SCENARIO\}\}/g,genScenario)}
    else if(slot==='TASK'){genTask=rnd(POOLS.TASKS);qText=qText.replace(/\{\{TASK\}\}/,genTask)}
    else if(slot==='TASK2'){qText=qText.replace(/\{\{TASK2\}\}/,rnd(POOLS.TASKS))}
    else if(slot==='TASK3'){qText=qText.replace(/\{\{TASK3\}\}/,rnd(POOLS.TASKS))}
    else if(slot==='EMOTION'){qText=qText.replace(/\{\{EMOTION\}\}/,rnd(POOLS.EMOTIONS))}
    else if(slot==='COLOUR'){genColour=rnd(POOLS.COLOURS);qText=qText.replace(/\{\{COLOUR\}\}/g,genColour)}
    else if(slot==='COLOUR2'){genColour2=rnd(POOLS.COLOURS.filter(c=>c!==genColour));qText=qText.replace(/\{\{COLOUR2\}\}/g,genColour2)}
    else if(slot==='NUMBER'){const num=rndInt(3,8);qText=qText.replace(/\{\{NUMBER\}\}/g,String(num))}
    else if(slot==='NUM1'){const n1=rndInt(2,12);qText=qText.replace(/\{\{NUM1\}\}/,String(n1))}
    else if(slot==='NUM2'){const n2=rndInt(2,12);qText=qText.replace(/\{\{NUM2\}\}/,String(n2))}
    else if(slot==='TIME_AGO'){qText=qText.replace(/\{\{TIME_AGO\}\}/,rndInt(3,12)+' minutes')}
    else if(slot==='MINS_AGO'){qText=qText.replace(/\{\{MINS_AGO\}\}/,String(rndInt(5,15)))}
    else if(slot==='TIMEFRAME'){qText=qText.replace(/\{\{TIMEFRAME\}\}/,rndInt(1,4)+' days')}
    else if(slot==='DAYS'){const d=rndInt(3,14);qText=qText.replace(/\{\{DAYS\}\}/g,String(d))}
    else if(slot==='TODAY'){qText=qText.replace(/\{\{TODAY\}\}/,'today')}
    else if(slot==='HOURS'){const h=rndInt(2,5);qText=qText.replace(/\{\{HOURS\}\}/g,String(h))}
    else if(slot==='TIME'){const h=rndInt(8,17);const m=rndInt(0,1)*30;qText=qText.replace(/\{\{TIME\}\}/g,`${h}:${m===0?'00':'30'}`)}
    else if(slot==='TRAVEL_MINS'){qText=qText.replace(/\{\{TRAVEL_MINS\}\}/,String(rndInt(10,30)))}
    else if(slot==='PREP_MINS'){qText=qText.replace(/\{\{PREP_MINS\}\}/,String(rndInt(5,20)))}
    else if(slot==='START_TIME'){qText=qText.replace(/\{\{START_TIME\}\}/,rndInt(8,10)+':00')}
    else if(slot==='STEPS'){qText=qText.replace(/\{\{STEPS\}\}/g,String(rndInt(4,7)))}
    else if(slot==='BLOCKED_STEPS'){qText=qText.replace(/\{\{BLOCKED_STEPS\}\}/g,String(rndInt(1,2)))}
    else if(slot==='WAIT_DAYS'){qText=qText.replace(/\{\{WAIT_DAYS\}\}/,String(rndInt(1,3)))}
    else if(slot==='ESTIMATE'){const est=rndInt(10,30);qText=qText.replace(/\{\{ESTIMATE\}\}/g,String(est))}
    else if(slot==='ACTUAL'){const act=rndInt(15,45);qText=qText.replace(/\{\{ACTUAL\}\}/g,String(act))}
    else if(slot==='DIFF'){qText=qText.replace(/\{\{DIFF\}\}/,String(rndInt(5,20)))}
    else if(slot==='INCOME'){qText=qText.replace(/\{\{INCOME\}\}/,String(rndInt(2000,4000)))}
    else if(slot==='FIXED'){qText=qText.replace(/\{\{FIXED\}\}/,String(rndInt(800,1500)))}
    else if(slot==='VARIABLE'){qText=qText.replace(/\{\{VARIABLE\}\}/,String(rndInt(200,600)))}
    else if(slot==='NEW_NAME'){qText=qText.replace(/\{\{NEW_NAME\}\}/,rnd(POOLS.NAMES))}
    else if(slot==='POSITION'){qText=qText.replace(/\{\{POSITION\}\}/,['first','second','third','fourth'][rndInt(0,3)])}
    else if(slot==='BLOCK_STEP'){qText=qText.replace(/\{\{BLOCK_STEP\}\}/,String(rndInt(1,2)))}
    else if(slot==='START'){qText=qText.replace(/\{\{START\}\}/g,String(rndInt(50,200)))}
    else if(slot==='STEP'){const st=rndInt(3,8);qText=qText.replace(/\{\{STEP\}\}/g,String(st))}
    else if(slot==='CURRENT'){qText=qText.replace(/\{\{CURRENT\}\}/,String(rndInt(20,50)))}
    else if(slot==='N'){const nv=rndInt(2,5);qText=qText.replace(/\{\{N\}\}/g,String(nv))}
    else if(slot==='LAST'){qText=qText.replace(/\{\{LAST\}\}/,String(rndInt(20,80)))}
    else if(slot==='SUBJECT'){qText=qText.replace(/\{\{SUBJECT\}\}/,rnd(['Maths','History','Science','English','Geography']))}
    else if(slot==='EVENT'){qText=qText.replace(/\{\{EVENT\}\}/,rnd(['a big test','a performance','a job interview','a presentation','a new school year']))}
    else if(slot==='PROJECT'){qText=qText.replace(/\{\{PROJECT\}\}/,rnd(['the science project','the report','the assignment','the presentation']))}
    else if(slot==='DAY'){qText=qText.replace(/\{\{DAY\}\}/,rnd(['Friday','Monday','Wednesday','next week']))}
    else if(slot==='ACTIVITY'){qText=qText.replace(/\{\{ACTIVITY\}\}/,rnd(['a video game','drawing','reading','watching TV','building something']))}
    else if(slot==='NEXT_TASK'){qText=qText.replace(/\{\{NEXT_TASK\}\}/,rnd(['homework','dinner','a phone call','tidying up','an appointment']))}
    else if(slot==='TIME_OF_DAY'){qText=qText.replace(/\{\{TIME_OF_DAY\}\}/,rnd(['mid-afternoon','late morning','early evening','after lunch']))}
    else if(slot==='SLEEP_TIME'){qText=qText.replace(/\{\{SLEEP_TIME\}\}/,rnd(['10:00pm','10:30pm','9:30pm','11:00pm']))}
    else if(slot==='DEPENDENCY'){qText=qText.replace(/\{\{DEPENDENCY\}\}/,rnd(['the internet','a specific tool','someone else\'s approval','a delivery']))}
  });

  // Clean up any remaining unreplaced tokens ‚Äî runs AFTER all slots processed
  qText=qText.replace(/\{\{[A-Z0-9_]+\}\}/g,'...');

  // Build correct answer from logic if not already set
  if(!correctAns){
    correctAns=resolveAnswer(correctLogic,genWords,genNumbers,r);
  }

  // Build distractors
  distractors=buildDistractors(distractorLogic,correctAns,genWords,genNumbers,r,fmt);

  // Ensure 4 options total
  const allOpts=[correctAns,...distractors.slice(0,3)];
  while(allOpts.length<4){allOpts.push(rnd(POOLS.WORDS))}
  return{qText,injected,correctAns,options:allOpts.slice(0,4)};
}

function resolveAnswer(logic,words,nums,r){
  if(logic.startsWith('words[')){
    const i=parseInt(logic.match(/\[(\d+)\]/)[1]);
    return words[i]||words[0]||'answer';
  }
  if(logic==='words[position-1]'){
    const positions=['first','second','third','fourth'];
    const tmpl=r[F.tmpl]||'';
    const posMatch=positions.findIndex(p=>tmpl.toLowerCase().includes(p));
    return words[posMatch>=0?posMatch:0]||words[0]||'answer';
  }
  if(logic.includes('next_in_sequence')&&nums.length){
    const step=nums[1]-nums[0];
    return String(nums[nums.length-1]+step);
  }
  if(logic.includes('missing_value')&&nums.length){
    return String(nums[Math.floor(nums.length/2)]);
  }
  if(logic.includes('reversed')&&words.length){
    return[...words].reverse().join('-');
  }
  if(logic.includes('exact_digit_string')&&words.length){
    return words.join('-');
  }
  // For scenario/choice questions, extract the first option phrase from distractor_logic context
  // Fall back to the first option suggested by the column
  return r[F.correct]||'See explanation';
}

function buildDistractors(logic,correct,words,nums,r,fmt){
  const d=[];
  if(words.length>1){
    const others=words.filter(w=>w!==correct);
    d.push(...rndN(3,others.length?others:words));
  } else if(nums.length){
    const step=nums.length>1?nums[1]-nums[0]:2;
    const base=parseInt(correct)||0;
    d.push(String(base+step),String(base-step),String(base+step*2));
  } else {
    // Scenario questions ‚Äî use distractor logic field split by |
    const parts=(r[F.distract]||'').split('_or_').map(s=>s.trim().replace(/_/g,' '));
    d.push(...parts.slice(0,3));
  }
  return d.filter(x=>x&&x!==correct).slice(0,3);
}

/* ‚ïê‚ïê ANSWER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function answer(btn,chosen,correct,explain,xpVal){
  clearInterval(timerInterval);
  const elapsed=timerLeft;
  timeTaken.push(elapsed);

  const isCorrect=chosen.trim().toLowerCase()===correct.trim().toLowerCase();
  const isBoss=sessionQ[qIdx]?.[F.boss]==='true';
  const earnedXP=isCorrect?(isBoss?xpVal*3:xpVal):0;

  // Style options
  document.querySelectorAll('.opt').forEach(o=>{
    o.disabled=true;
    const otxt=o.textContent.slice(1).trim();
    if(otxt.trim().toLowerCase()===correct.trim().toLowerCase()){
      o.classList.add(isCorrect&&otxt.trim().toLowerCase()===chosen.trim().toLowerCase()?'correct':'reveal');
    }
    if(!isCorrect&&otxt.trim().toLowerCase()===chosen.trim().toLowerCase()){
      o.classList.add('wrong');
    }
  });

  // Feedback
  const fb=document.getElementById('feedback');
  if(isCorrect){
    fb.className='feedback correct';
    fb.textContent=explain||'Correct!';
    correct&&(combo++);
    document.getElementById('combo-badge').textContent=`üî• ${combo}√ó Combo`;
    if(combo>=2)document.getElementById('combo-badge').classList.add('show');
  } else {
    fb.className='feedback wrong';
    fb.innerHTML=`<strong>Not quite.</strong> The correct answer was: <strong>${correct}</strong>${explain?'. '+explain:''}`;
    combo=0;document.getElementById('combo-badge').classList.remove('show');
  }
  fb.style.display='block';

  // XP
  if(earnedXP>0){
    sessionXP+=earnedXP;
    document.getElementById('xp-tally').textContent=`+${sessionXP} XP`;
    const fl=document.getElementById('xp-flash');
    fl.textContent=`+${earnedXP} XP${isBoss?' üëπ':''}${combo>=3?' üî•':''}`;
    fl.style.display='block';
    setTimeout(()=>fl.style.display='none',900);
  }

  // Category stats
  const cat=sessionQ[qIdx]?.[F.cat]||'';
  if(!catStats[cat])catStats[cat]={a:0,t:0};
  catStats[cat].t++;
  if(isCorrect)catStats[cat].a++;

  // Write XP if earned
  if(earnedXP>0)writeSharedXP(earnedXP,'game',r[1]||'',null);

  correct_count: if(isCorrect)correct++;
  document.getElementById('btn-next').style.display='block';
  document.getElementById('hint-btn').disabled=true;

  // Sage comment
  const comments=isCorrect?
    ['Exactly right ‚Äî nice work.','Correct. That skill is getting stronger.','That\'s the one. Keep going.']:
    ['Not quite this time ‚Äî read the explanation and it will click.','Close. The explanation shows the key difference.','Happens ‚Äî the explanation is worth reading carefully.'];
  document.getElementById('sage-txt').innerHTML=`<strong>Sage:</strong> ${rnd(comments)}`;
}

/* ‚ïê‚ïê HINT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function useHint(){
  if(hintShown)return;
  hintShown=true;
  sessionXP=Math.max(0,sessionXP-5);
  document.getElementById('xp-tally').textContent=`+${sessionXP} XP`;
  document.getElementById('hint-box').style.display='block';
  document.getElementById('hint-btn').disabled=true;
  hintUsed++;
  toast('üí° Hint revealed (-5 XP)');
}

/* ‚ïê‚ïê TIMER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function startTimer(secs,cc){
  timerLeft=secs;
  const circ=2*Math.PI*34;
  const fill=document.getElementById('timer-fill');
  const num=document.getElementById('timer-num');
  fill.style.stroke=cc;
  fill.setAttribute('stroke-dasharray',circ);
  fill.setAttribute('stroke-dashoffset','0');
  num.textContent=secs;num.style.color=cc;

  clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    timerLeft--;
    const pct=timerLeft/secs;
    fill.style.strokeDashoffset=String(circ*(1-pct));
    num.textContent=timerLeft;
    if(timerLeft<=5){fill.style.stroke=var_rose();num.style.color=var_rose()}
    if(timerLeft<=0){
      clearInterval(timerInterval);
      // Time's up ‚Äî auto-skip
      document.querySelectorAll('.opt').forEach(o=>o.disabled=true);
      combo=0;
      document.getElementById('feedback').className='feedback wrong';
      document.getElementById('feedback').innerHTML=`<strong>Time's up!</strong> ${sessionQ[qIdx]?.[F.explain]||''}`;
      document.getElementById('feedback').style.display='block';
      document.getElementById('btn-next').style.display='block';
      document.getElementById('sage-txt').innerHTML=`<strong>Sage:</strong> Time ran out ‚Äî but you saw the question. That still builds pattern recognition.`;
    }
  },1000);
}
function var_rose(){return'#ff5e7d'}

/* ‚ïê‚ïê NEXT / END ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function nextQuestion(){qIdx++;renderQuestion()}

function endSession(){
  clearInterval(timerInterval);
  const total=sessionQ.length;
  const acc=total>0?Math.round((correct/total)*100):0;
  const avgTime=timeTaken.length?Math.round(timeTaken.reduce((a,b)=>a+b,0)/timeTaken.length):0;

  document.getElementById('r-icon').textContent=acc>=80?'üèÜ':acc>=50?'üéÆ':'üí™';
  document.getElementById('r-title').textContent=acc>=80?'Excellent Session!':acc>=50?'Solid Work!':'Keep Practising!';
  document.getElementById('r-sub').textContent=acc>=80?
    'Great accuracy. Your training is working.':
    acc>=50?'Good session. The questions you got wrong are building awareness even so.':
    'Lower scores are fine at first ‚Äî the brain is still processing. Come back and try again.';

  document.getElementById('r-xp').textContent=sessionXP;
  document.getElementById('r-acc').textContent=acc+'%';
  document.getElementById('r-time').textContent=avgTime+'s';

  // Category breakdown
  const bd=document.getElementById('cat-breakdown');
  const activeCats=Object.entries(catStats).filter(([_,v])=>v.t>0);
  if(activeCats.length){
    bd.innerHTML=`<h4>Category Breakdown</h4>`+
      activeCats.map(([cat,v])=>`
        <div class="cb-row">
          <span class="cb-icon">${CAT_ICON[cat]||'‚ö°'}</span>
          <span class="cb-label">${cat}</span>
          <span class="cb-score" style="color:${CAT_COLOR[cat]}">${v.a}/${v.t}</span>
        </div>`).join('');
  }

  // Write session to shared state
  writeSharedXP(0,'game',selMode,null,acc+'%');

  hide('screen-game');
  show('screen-result');

  // Check speed badge
  const fastQ=timeTaken.filter(t=>t>=15).length;
  if(fastQ>=5){
    const b=ld('badges',{});
    if(!b.badge_speed){b.badge_speed=Date.now();sv('badges',b);toast('üèÖ Badge: Speed Demon!')}
  }
  if(hintUsed===0&&total>=5){
    const b=ld('badges',{});
    if(!b.badge_nohint){b.badge_nohint=Date.now();sv('badges',b);toast('üèÖ Badge: Hint-Free!')}
  }
}

/* ‚ïê‚ïê SHARED STATE WRITE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function writeSharedXP(xpAmt,mode,cat,cardId,score){
  let xp=ld('xp',0);xp+=xpAmt;sv('xp',xp);
  let sess=ld('sessions',0)+1;sv('sessions',sess);
  const today=new Date().toDateString();
  let str=ld('streak',0),ld2=ld('lastDate','');
  if(ld2!==today){
    const yest=new Date(Date.now()-86400000).toDateString();
    str=(ld2===yest)?str+1:1;
    sv('streak',str);sv('lastDate',today);
  }
  if(cat){const dc=ld('doneCats',{});dc[cat]=(dc[cat]||0)+1;sv('doneCats',dc)}
  const hist=ld('history',[]);
  hist.push({ts:Date.now(),mode,label:selMode+' session',cat,cardId,xp:xpAmt,score,level:getLv(xp).n});
  sv('history',hist);
}

function getLv(v){
  const L=[{n:1,xp:0},{n:2,xp:150},{n:3,xp:400},{n:4,xp:750},
    {n:5,xp:1200},{n:6,xp:1800},{n:7,xp:2600},{n:8,xp:3600}];
  let l=L[0];for(const x of L){if(v>=x.xp)l=x;else break}return l;
}

/* ‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function shuffle(arr){return arr.sort(()=>Math.random()-.5)}
function show(id){document.getElementById(id).style.display='flex'}
function hide(id){document.getElementById(id).style.display='none'}
function escQ(s){return(s||'').replace(/'/g,"\\'")}

let toastT;
function toast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');
  clearTimeout(toastT);toastT=setTimeout(()=>el.classList.remove('show'),3000);
}
function openTA(){
  const ctx=sessionQ[qIdx]?`?q=${sessionQ[qIdx][F.id]||''}&cat=${encodeURIComponent(sessionQ[qIdx][F.cat]||'')}`:''
  window.open(TA_URL+ctx,'_blank');
}
</script>
</body>
</html>
